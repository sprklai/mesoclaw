# Code Review Report (2026-02-18)

## Scope
Reviewed commits from `e1820d08b8c53df7ebd1b947ef386e2a6fd1e08a` (exclusive) through `HEAD` (inclusive):
- `53a95da` feat(phase-2.2/2.3): Security Policy + Tool Trait & Registry
- `d635d4e` feat(phase-2.4): Identity System — loader, hot-reload, IPC commands
- `faf19a9` feat(phase-2.5): HTTP Gateway — REST + WebSocket daemon
- `fc8f1ae` feat(phase2.7): frontend gateway client, identity store, and status indicator
- `b3358d6` feat(phase2.8): sidecar module system core
- `83974aa` feat(phase2.9-2.10): add container runtime abstraction and MCP protocol client
- `41534e2` feat(phase3.1): implement agent loop with dual-format tool-call parser
- `45ad74d` feat(phase3.2): implement Memory subsystem with hybrid recall
- `34034c7` feat(phase3.3): add DailyMemory filesystem store and system prompt injection
- `631cf2e` feat(phase4.1): implement Scheduler / Heartbeat subsystem
- `62068c8` feat(phase4.2): add NotificationService with event routing and DND support
- `b5d8d9b` feat(phase4.3): implement SessionRouter with structured session keys
- `7151743` feat(phase4.4): implement SidecarService for long-lived module management
- `651c178` feat(phase5.1): TOML configuration system with env overrides and atomic save
- `a143d96` feat(phase5.2): ModelRouter for task-type and alias-based provider selection
- `86af9f2` feat(phase5.3): add prelude module with convenience re-exports
- `f081387` feat(phase5.4): harden dual tool-call parser with edge cases and streaming detection
- `bd86799` feat(phase5.5): module CLI subcommand and gateway endpoints
- `11fe72a` feat(phase5.6): Tauri plugin baseline hardening — add shell, single-instance, updater, deep-link
- `1292db0` feat: introduce core channel abstractions for inter-agent messaging.

## Findings (Ordered by Severity)

### 1) High: Shell policy can be bypassed because validation inspects only first token while execution runs full `sh -c` command
- Location: `src-tauri/src/security/policy.rs:153`, `src-tauri/src/security/policy.rs:273`, `src-tauri/src/security/policy.rs:312`, `src-tauri/src/tools/shell.rs:91`
- What happens:
1. `validate_command` classifies/blocks based on `extract_executable` (first whitespace token only).
2. `ShellTool` executes full user input through `sh -c`.
3. Inputs like `FOO=1 rm -rf /tmp/x` or multiline commands can evade first-token executable blocking and still execute dangerous commands.
- Impact:
1. Security boundary is not reliable for shell execution.
2. High-risk commands may run under an apparently “allowed” decision.
- Affected commits:
1. `53a95da` (security policy)
2. `11fe72a` (shell tool integration)

### 2) High: Module scaffold generates relative executable path that runtime does not resolve from module directory
- Location: `src-tauri/src/bin/cli.rs:518`, `src-tauri/src/modules/sidecar_tool.rs:218`
- What happens:
1. `mesoclaw module create` writes `command = "./<name>"`.
2. `SidecarTool::spawn_native_child` executes this command without setting `current_dir` to the module folder.
3. Relative path resolution depends on daemon process CWD, so newly scaffolded modules can fail to start.
- Impact:
1. Freshly created modules are often non-runnable without manual manifest edits.
2. Breaks default path for module authoring.
- Affected commits:
1. `bd86799` (CLI scaffold)
2. `b3358d6` (module execution path)

### 3) Medium: Gateway module/session endpoints return success-like responses but are stubs with no backend effect
- Location: `src-tauri/src/gateway/routes.rs:35`, `src-tauri/src/gateway/routes.rs:54`, `src-tauri/src/gateway/routes.rs:85`, `src-tauri/src/gateway/routes.rs:108`, `src-tauri/src/gateway/routes.rs:120`, `src-tauri/src/gateway/routes.rs:132`
- What happens:
1. Create/list/start/stop/reload endpoints return `201/202/200` payloads.
2. Handlers explicitly do not perform real session/module operations yet.
- Impact:
1. API clients receive successful responses for operations that are not executed.
2. Operational tooling may report false success and drift from actual daemon state.
- Affected commits:
1. `faf19a9`
2. `bd86799`

### 4) Medium: `daemon start` is foreground-blocking despite daemon-management command semantics
- Location: `src-tauri/src/bin/cli.rs:366`, `src-tauri/src/bin/cli.rs:377`
- What happens:
1. `mesoclaw daemon start` directly awaits `start_gateway(bus).await`.
2. CLI process does not return to shell (runs as foreground server).
- Impact:
1. Conflicts with expected daemon lifecycle UX for scripts and users.
2. “start then continue” workflows block until process termination.
- Affected commits:
1. `faf19a9`
2. `bd86799`

### 5) Medium: Channel wiring creates output-to-input loop potential on `AgentComplete`
- Location: `src-tauri/src/channels/tauri_ipc.rs:36`, `src-tauri/src/channels/tauri_ipc.rs:44`, `src-tauri/src/channels/tauri_ipc.rs:75`
- What happens:
1. `send()` publishes `AppEvent::AgentComplete`.
2. `listen()` subscribes to bus events and converts `AppEvent::AgentComplete` back into inbound `ChannelMessage`.
- Impact:
1. When integrated into the full channel/agent loop, agent outputs can be re-ingested as new channel inputs, causing feedback loops/echo storms.
- Affected commits:
1. `1292db0`

## Validation Performed
- `cargo test -p mesoclaw --manifest-path src-tauri/Cargo.toml`
- Result: `341 passed`, `5 failed`.
- Failing tests are in `src-tauri/src/services/credential_store.rs` and fail with keyring platform permission errors (`Operation not permitted`) in this environment; these failures are not from files changed in this review range.

## Residual Risk / Test Gaps
- No tests currently cover shell-policy bypass cases such as env-prefix/multiline command forms.
- No integration test verifies that scaffolded modules execute successfully end-to-end.
- No contract tests verify gateway endpoints mutate and reflect real runtime state.

---

## Fix Status (2026-02-18)

All 5 findings addressed. Test suite: **355 passed, 0 failed** (14 new tests added).

### Finding 1 ✅ Fixed — Shell policy env-prefix / newline bypass
- **`src-tauri/src/security/policy.rs`**: `extract_executable` now skips leading `VAR=value` tokens via `.find(|t| !t.contains('='))`, so `FOO=1 rm -rf /tmp/x` correctly identifies `rm` as the executable.
- **`src-tauri/src/security/policy.rs`**: `detect_injection` now catches `\n` and `\r` as injection patterns, blocking multiline command forms.
- Added 5 tests: `env_prefix_blocked_executable_denied`, `env_prefix_multiple_vars_blocked_executable_denied`, `env_prefix_preserves_low_risk_classification`, `newline_injection_denied`, `carriage_return_injection_denied`.

### Finding 2 ✅ Fixed — Module scaffold relative executable path
- **`src-tauri/src/modules/sidecar_tool.rs`**: Added `module_dir: PathBuf` field to `SidecarTool`; `spawn_native_child` now calls `.current_dir(&self.module_dir)` so that `"./<name>"` resolves relative to the module folder regardless of daemon CWD.
- **`src-tauri/src/modules/mod.rs`**: `SidecarTool::new` call updated to pass `path` (the discovered module directory) as `module_dir`.

### Finding 3 ✅ Fixed — Gateway stubs return misleading HTTP status codes
- **`src-tauri/src/gateway/routes.rs`**: `create_session`, `start_module`, and `stop_module` now return `StatusCode::NOT_IMPLEMENTED` (501) with an `"error"` payload, making it unambiguous to API clients that the operation was not performed.

### Finding 4 ✅ Fixed — `daemon start` blocks the shell
- **`src-tauri/src/bin/cli.rs`**: Added hidden `--foreground` flag to `DaemonArgs`. `daemon start` now self-spawns the binary with `--foreground` (stdio redirected to null) and returns immediately to the shell. The spawned child runs `start_gateway` in foreground mode.

### Finding 5 ✅ Fixed — Channel feedback loop on `AgentComplete`
- **`src-tauri/src/channels/tauri_ipc.rs`**: `event_to_channel_message` now returns `None` for `AgentComplete` events (and all other events). A comment documents the Phase 6+ TODO to match on a future `UserTurn` event instead. This eliminates the output→input re-ingestion loop.
